<!DOCTYPE html>
<!-- saved from url=(0047)https://sarangaranaweera.github.io/loading-app/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEB-V4</title>

    <style>
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .form-section {
                display: none !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 10px;
            line-height: 1.2;
            color: #000;
            background: #f5f5f5;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .form-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #FFFFFF;
            border-bottom: 2px solid #007acc;
            padding-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            color: #FFFFFF;
        }

        .black-clr {
            color: #101010;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        }

        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.3);
            background: rgba(255, 255, 255, 1);
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .autocomplete-item:hover {
            background: #f0f8ff;
        }

        .line-items-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .line-item-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary-2 {
            background: #007acc;
            color: white;
            font-size: 10px;
            padding: 5px 8px;
            text-align: right;
            float: right;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 11px;
        }

        .line-items-table th,
        .line-items-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .line-items-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .line-items-table .text-right {
            text-align: right;
        }

        .grand-total {
            font-size: 14px;
            font-weight: bold;
            background: #e9ecef;
        }

        .container {
            max-width: 210mm;
            margin: 20px auto;
            padding: 10px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            align-items: center;
            border: 2px solid #000;
            margin-bottom: 2px;
        }

        .logo-section {
            width: 60px;
            border-right: 2px solid #000;
            padding: 5px;
            text-align: center;
        }

        .logo {
            width: 40px;
            height: 40px;
            border: 1px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 8px;
            background: #f0f0f0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .title-section {
            flex: 1;
            padding: 10px;
            text-align: center;
        }

        .main-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .subtitle {
            font-size: 10px;
        }

        .office-info {
            width: 150px;
            border-left: 2px solid #000;
            padding: 10px;
            text-align: center;
        }

        .office-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .info-section {
            display: flex;
            border: 2px solid #000;
            border-top: none;
            margin-bottom: 2px;
        }

        .info-left {
            flex: 1;
            border-right: 1px solid #000;
        }

        .info-right {
            width: 150px;
        }

        .info-row {
            display: flex;
            border-bottom: 1px solid #000;
            min-height: 25px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            width: 120px;
            padding: 5px 8px;
            border-right: 1px solid #000;
            background: #f8f8f8;
        }

        .info-value {
            flex: 1;
            padding: 5px 8px;
        }

        .table-container {
            border: 2px solid #000;
            margin-bottom: 2px;
        }

        .table-header {
            display: flex;
            background: #f0f0f0;
            border-bottom: 2px solid #000;
            font-weight: bold;
            text-align: center;
        }

        .col-sn { width: 60px; text-align: left; }
        .col-description { flex: 1; }
        .col-unit { width: 40px; }
        .col-rate { width: 50px; }
        .col-qty { width: 30px; }
        .col-amount { width: 70px; }
        .col-cert-qty { width: 50px; }
        .col-cert-amount { width: 100px; }

        .table-header > div {
            padding: 8px 4px;
            border-right: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-header > div:last-child {
            border-right: none;
        }

        .table-row {
            display: flex;
            border-bottom: 1px solid #000;
            min-height: 20px;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row > div {
            padding: 3px 4px;
            border-right: 1px solid #000;
            font-size: 9px;
        }

        .table-row > div:last-child {
            border-right: none;
        }

        .summary-section {
            border: 2px solid #000;
            border-top: none;
            min-height: 80px;
        }

        .summary-text {
            padding: 10px;
            text-align: center;
            font-size: 9px;
            line-height: 1.4;
        }

        .signature-section {
            display: flex;
            border: 2px solid #000;
            border-top: none;
            margin-bottom: 2px;
        }

        .signature-left {
            flex: 1;
            border-right: 1px solid #000;
            padding: 10px;
        }

        .signature-right {
            width: 200px;
            padding: 10px;
        }

        .signature-row {
            margin-bottom: 15px;
        }

        .signature-label {
            font-size: 9px;
            margin-bottom: 20px;
        }

        .signature-line {
            border-bottom: 1px solid #000;
            height: 1px;
            margin-bottom: 5px;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 8px;
            margin-top: 10px;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .status-indicator {
            font-size: 11px;
            color: #666;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-notification.show {
            opacity: 1;
        }

        /* Night Sky Background Styles */
        .night-sky-background {
            position: relative;
            overflow: hidden;
            background: linear-gradient(to bottom, #0B1426 0%, #1a1a2e 50%, #16213e 100%);
            min-height: auto;
            height: auto;
        }

        .night-sky-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                /* Night sky gradient */
                linear-gradient(to bottom, #0B1426 0%, #1a1a2e 50%, #16213e 100%),
                /* Subtle star field */
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 30%, rgba(255,255,255,0.05) 0%, transparent 40%),
                radial-gradient(circle at 50% 60%, rgba(255,255,255,0.08) 0%, transparent 45%);
            z-index: 1;
        }



        /* Moon */
        .moon {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 45px;
            background: radial-gradient(circle, #F5F5DC 0%, #E6E6FA 50%, #D3D3D3 100%);
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 0 20px rgba(245, 245, 220, 0.5);
            animation: moonrise 1800s linear infinite;
        }

        .moon::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 12px;
            width: 10px;
            height: 10px;
            background: rgba(200, 200, 200, 0.6);
            border-radius: 50%;
        }

        /* Stars */
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #FFFFFF;
            border-radius: 50%;
            z-index: 2;
            animation: starTwinkle 3s ease-in-out infinite;
        }

        .star-1 { top: 20px; left: 15%; animation-delay: 0s; }
        .star-2 { top: 35px; left: 25%; animation-delay: 0.5s; }
        .star-3 { top: 15px; left: 40%; animation-delay: 1s; }
        .star-4 { top: 45px; left: 55%; animation-delay: 1.5s; }
        .star-5 { top: 25px; left: 70%; animation-delay: 2s; }
        .star-6 { top: 40px; left: 85%; animation-delay: 2.5s; }
        .star-7 { top: 30px; left: 10%; animation-delay: 0.3s; }
        .star-8 { top: 50px; left: 30%; animation-delay: 0.8s; }
        .star-9 { top: 18px; left: 45%; animation-delay: 1.3s; }
        .star-10 { top: 38px; left: 60%; animation-delay: 1.8s; }
        .star-11 { top: 28px; left: 75%; animation-delay: 2.3s; }
        .star-12 { top: 42px; left: 90%; animation-delay: 0.7s; }
        .star-13 { top: 22px; left: 20%; animation-delay: 1.2s; }
        .star-14 { top: 48px; left: 35%; animation-delay: 1.7s; }
        .star-15 { top: 32px; left: 50%; animation-delay: 2.2s; }

        /* Asteroids */
        .asteroid {
            position: absolute;
            width: 3px;
            height: 3px;
            background: linear-gradient(45deg, #8B4513, #A0522D, #CD853F);
            border-radius: 50%;
            z-index: 2;
            animation: asteroidShower 8s linear infinite;
        }

        .asteroid::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 50%;
            animation: asteroidGlow 2s ease-in-out infinite;
        }

        .asteroid-1 { top: 10px; left: -5px; animation-delay: 0s; }
        .asteroid-2 { top: 25px; left: -5px; animation-delay: 1s; }
        .asteroid-3 { top: 40px; left: -5px; animation-delay: 2s; }
        .asteroid-4 { top: 15px; left: -5px; animation-delay: 3s; }
        .asteroid-5 { top: 30px; left: -5px; animation-delay: 4s; }
        .asteroid-6 { top: 45px; left: -5px; animation-delay: 5s; }
        .asteroid-7 { top: 20px; left: -5px; animation-delay: 6s; }
        .asteroid-8 { top: 35px; left: -5px; animation-delay: 7s; }

        /* Star Twinkle Animation */
        @keyframes starTwinkle {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Asteroid Shower Animation */
        @keyframes asteroidShower {
            0% {
                transform: translateX(0px) translateY(0px) rotate(0deg);
                left: -5px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 10px)) translateY(50px) rotate(360deg);
                left: 0;
                opacity: 0;
            }
        }

        @keyframes asteroidGlow {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.5);
            }
        }

        /* Moonrise Animation */
        @keyframes moonrise {
            0% {
                top: 100%;
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
            5% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
            45% {
                top: 50%;
                transform: translateX(-50%) scale(1.2);
            }
            50% {
                top: 45%;
                transform: translateX(-50%) scale(1.1);
            }
            95% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
            100% {
                top: -10%;
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
        }

        /* Ensure form content is above background */
        .form-section > * {
            position: relative;
            z-index: 3;
        }

        @media screen and (max-width: 800px) {
            .line-item-form {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container" x-data="invoiceApp()" x-init="init()">
        
        <!-- Form Section -->
        <div class="form-section no-print night-sky-background">
            <!-- Night Sky Elements -->
            <div class="moon"></div>
            
            <div class="star star-1"></div>
            <div class="star star-2"></div>
            <div class="star star-3"></div>
            <div class="star star-4"></div>
            <div class="star star-5"></div>
            <div class="star star-6"></div>
            <div class="star star-7"></div>
            <div class="star star-8"></div>
            <div class="star star-9"></div>
            <div class="star star-10"></div>
            <div class="star star-11"></div>
            <div class="star star-12"></div>
            <div class="star star-13"></div>
            <div class="star star-14"></div>
            <div class="star star-15"></div>
            
            <div class="asteroid asteroid-1"></div>
            <div class="asteroid asteroid-2"></div>
            <div class="asteroid asteroid-3"></div>
            <div class="asteroid asteroid-4"></div>
            <div class="asteroid asteroid-5"></div>
            <div class="asteroid asteroid-6"></div>
            <div class="asteroid asteroid-7"></div>
            <div class="asteroid asteroid-8"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>C.E.B. Contractor Billing System</h2>
                <div style="font-size: 11px; color: #FFFFFF; text-shadow: 0 1px 2px rgba(0,0,0,0.7);">
                    Auto-save: <span x-text="getLastSaved()">Never</span>
                </div>
            </div>
                         <div class="form-row">
                 <div class="form-group">
                     <label>Contractor Name</label>
                     <input type="text" x-model="invoiceData.contractorName" @input="saveToStorage()" placeholder="Enter contractor name">
                 </div>
                 <div class="form-group">
                     <label>Location</label>
                     <input type="text" x-model="invoiceData.location" @input="saveToStorage()" placeholder="Enter location">
                 </div>
                 <div class="form-group">
                     <label>Service Number</label>
                     <input type="text" x-model="invoiceData.serviceNumber" @input="saveToStorage()" placeholder="Enter service number">
                 </div>
                 <div class="form-group">
                     <label>Report Date</label>
                     <input type="date" x-model="invoiceData.reportDate" @input="saveToStorage()">
                 </div>
             </div>
             <div class="form-row">
                 <div class="form-group">
                     <label>Office Name</label>
                     <input type="text" x-model="invoiceData.officeName" @input="saveToStorage()" placeholder="Enter office name (e.g., Area Office - Matara)">
                 </div>
             </div>
        </div>

        <!-- Line Items Section -->
        <div class="line-items-section no-print">
            <button type="button" class="btn btn-primary-2" @click="clearInvoice()">
               + New Invoice
            </button>
            <h2>Line Items</h2>
            
            <!-- Add Line Item Form -->
            <div class="line-item-form">
                <div class="form-group" >
                    <label style="color: #101010;">Description</label>
                    <div class="autocomplete-container">
                        <input type="text" x-model="currentItem.description" @input="showSuggestions = true; console.log('Input changed:', currentItem.description)" @blur="setTimeout(() =&gt; showSuggestions = false, 200)" placeholder="Start typing description...">
                        <div style="font-size: 10px; color: #666; margin-top: 2px;" x-show="showSuggestions">
                        </div>
                        <div class="autocomplete-suggestions" :class="{ &#39;show&#39;: showSuggestions &amp;&amp; filteredSuggestions.length &gt; 0 }">
                            <template x-for="suggestion in filteredSuggestions" :key="suggestion.description">
                                <div class="autocomplete-item" @click="selectSuggestion(suggestion)">
                                    <div style="font-weight: bold; color: #007acc;" x-text="suggestion.ino"></div>
                                    <div x-text="suggestion.description"></div>
                                    <small style="color: #666;">Rate: Rs. <span x-text="suggestion.rate"></span> | Unit: <span x-text="suggestion.unit"></span></small>
                                </div>
                            </template>
                            <div x-show="showSuggestions && filteredSuggestions.length === 0" style="padding: 10px; color: #666; font-style: italic;">
                                No suggestions found
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: #101010;">Rate (Rs.)</label>
                    <input type="number" readonly x-model.number="currentItem.rate" @input="calculateAmount()" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label style="color: #101010;">Quantity</label>
                    <input type="number" step="1" min="0" max="1000" x-model.number="currentItem.quantity" @input="calculateAmount()" step="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label style="color: #101010;">Amount (Rs.)</label>
                    <input type="number" min="0" max="1000000" x-model.number="currentItem.amount" readonly="" style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" @click="addLineItem()" :disabled="!canAddItem()" disabled="disabled">
                        Add Item
                    </button>
                </div>
            </div>

            <!-- Line Items Table -->
            <table class="line-items-table" x-show="lineItems.length &gt; 0" style="display: none;">
                <thead>
                    <tr>
                        <th style="width: 50px;">I/No</th>
                        <th>Description</th>
                        <th style="width: 60px;">Unit</th>
                        <th style="width: 80px;">Rate (Rs.)</th>
                        <th style="width: 80px;">Qty.</th>
                        <th style="width: 100px;">Amount (Rs.)</th>
                        <th style="width: 80px;" class="no-print">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(item, index) in lineItems" :key="index">
                        <tr>
                            <td x-text="item.ino"></td>
                            <td x-text="item.description"></td>
                            <td x-text="item.unit"></td>
                            <td class="text-right" x-text="'Rs. ' + parseFloat(item.rate).toFixed(2)"></td>
                            <td class="text-right" x-text="parseFloat(item.quantity).toFixed(2)"></td>
                            <td class="text-right" x-text="'Rs. ' + parseFloat(item.amount).toFixed(2)"></td>
                            <td class="no-print">
                                <button type="button" class="btn btn-danger" @click="removeLineItem(index)" style="padding: 4px 8px; font-size: 10px;">Delete</button>
                            </td>
                        </tr>
                    </template>
                    <tr class="grand-total">
                        <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                        <td class="text-right" style="font-weight: bold;" x-text="&#39;Rs. &#39; + grandTotal.toFixed(2)">Rs. 0.00</td>
                        <td class="no-print"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Print Controls -->
        <div class="controls no-print">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center;">
                <button type="button" class="btn btn-success" @click="printInvoice()" :disabled="lineItems.length === 0" disabled="disabled">
                    Print Invoice
                </button>


            </div>
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #666;">
                Last saved: <span x-text="getLastSaved()">Never</span>
                <br>
                <small style="font-size: 10px; color: #999;">
                    üíæ Auto-saves every 30 seconds ‚Ä¢ Ctrl+S to save manually
                </small>
            </div>
        </div>

        <!-- Invoice Template -->
        <div class="container">
            <!-- Header Section -->
            <div class="header">
                <div class="logo-section">
                    <div class="logo" style="background-image: url('./ceblogo.PNG');"></div>
                </div>
                <div class="title-section">
                    <div class="main-title">Contractor Invoice</div>
                </div>
                                 <div class="office-info">
                     <div class="office-title">Ceylon Electricity Board</div>
                     <div x-text="invoiceData.officeName">Area Office - Matara</div>
                 </div>
            </div>

            <!-- Information Section -->
            <div class="info-section">
                <div class="info-left">
                    <div class="info-row">
                        <div class="info-label">Contractor Name :</div>
                        <div class="info-value" x-text="invoiceData.contractorName"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Job Name :</div>
                        <div class="info-value" x-text="invoiceData.location"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Job Number :</div>
                        <div class="info-value" x-text="invoiceData.serviceNumber"></div>
                    </div>
                </div>
                <div class="info-right">
                    <div class="info-row">
                        <div class="info-value" style="text-align: center; font-weight: bold;">Bill No.</div>
                    </div>
                    <div class="info-row">
                        <div class="info-value"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">End Date :</div>
                        <div class="info-value" x-text="formatDate(invoiceData.reportDate)"></div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-container">
                <div class="table-header">
                    <div class="col-sn">I/No</div>
                    <div class="col-description">Description</div>
                    <div class="col-rate">Rate<br>(Rs.)</div>
                    <div class="col-qty">Qty.</div>
                    <div class="col-amount">Amount<br>(Rs.)</div>
                    <div class="col-cert-qty">Certified<br>Qty.</div>
                    <div class="col-cert-amount">Amount (Rs.)</div>
                </div>

                <!-- Dynamic Table Rows -->
                <template x-for="(item, index) in printableRows" :key="index">
                    <div class="table-row">
                        <div class="col-sn" x-text="item.ino"></div>
                        <div class="col-description" x-text="item.description"></div>
                        <div class="col-rate" style="text-align: right;" x-text="item.rate"></div>
                        <div class="col-qty" x-text="item.quantity"></div>
                        <div class="col-amount" style="text-align: right;" x-text="item.amount"></div>
                        <div class="col-cert-qty" x-text="item.certifiedQty"></div>
                        <div class="col-cert-amount" x-text="item.certifiedAmount"></div>
                    </div>
                </template>
                
                <!-- Total Row -->
                <div class="table-row" style="background: #f0f0f0; font-weight: bold; border-top: 2px solid #000;">
                    <div class="col-sn"></div>
                    <div class="col-description" style="text-align: center;">TOTAL</div>
                    <div class="col-rate"></div>
                    <div class="col-qty"></div>
                    <div class="col-amount" style="text-align: right;" x-text="grandTotal.toFixed(2)">0.00</div>
                    <div class="col-cert-qty"></div>
                    <div class="col-cert-amount" ></div>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="summary-section">
                <div class="summary-text">
                    Total : <span x-text="grandTotal.toFixed(2)">0.00</span><br><br>
                    ‡∂ú‡∂∏ ‡∂±‡∑í‡∂∫‡∑É ‡∂∏‡∂±‡∑ä‡∂≠‡∑ä‚Äç‡∂ª‡∑ì ‡∂Ω.‡∂∏. ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∂≠‡∑í‡∂ú‡∂Ω‡∑ö ‡∂Ö‡∂±‡∑î‡∂ö‡∑ñ‡∂Ω ‡∂±‡∑î‡∂≠‡∑í ‡∑É‡∑Ñ ‡∂á.‡∂Ø. ‡∂Ö‡∂±‡∑î‡∂ö‡∑ñ‡∂Ω ‡∂¥‡∂ª‡∑î‡∂ö‡∑ä‚Äç‡∑Ç‡∑Ä ‡∑Ñ‡∑ù ‡∂¥‡∂±‡∑ä‡∂± ‡∂Ω‡∂∂‡∂± ‡∂¥‡∂±‡∂≠‡∑ä ‡∂¥‡∂Ω‡∂∏‡∑ä ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±.
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section">
                <div class="signature-left">
                    <div class="signature-row">
                        <div class="signature-label">‡∂ö‡∑ù‡∂±‡∑ä‡∂≠‡∑ä‚Äç‡∂ª‡∑è‡∂≠‡∑ä‡∂ö‡∂ª‡∑î‡∂ú‡∑ö ‡∂Ö‡∂≠‡∑ä‡∑É‡∂±</div>
                        <div class="signature-line"></div>
                    </div>
                    <div class="signature-row">
                        <div class="signature-label">‡∂±‡∂∏.‡∂¥.‡∂±‡∂∏. ‡∂Ö‡∂≠‡∑ä‡∑É‡∂±</div>
                        <div class="signature-line"></div>
                    </div>
                    <div class="signature-row">
                        <div class="signature-label">‡∂Ø‡∑í.‡∂∫. (‡∂¥.‡∑Ä‡∑ö.‡∂∏. /‡∂¥.‡∂±‡∂∏.‡∂∫.)</div>
                        <div class="signature-line"></div>
                    </div>
                </div>
                <div class="signature-right">
                    <div class="signature-row">
                        <div class="signature-label">‡∑Ä‡∑ö.‡∂â.‡∂±‡∑í‡∂∫‡∂∏‡∑î‡∂≠‡∑ä‡∂ö‡∂ª‡∑î‡∂ú‡∑ö ‡∑É‡∑Ñ‡∂≠‡∑í‡∂ö</div>
                        <div class="signature-line"></div>
                    </div>
                    <div class="signature-row">
                        <div class="signature-label">‡∑Ä‡∑ö.‡∂¥.(‡∂∏.‡∑Ä‡∑í./‡∂¥.‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑î‡∂ö‡∑ä‚Äç‡∑Ç.</div>
                        <div class="signature-line"></div>
                    </div>
                </div>
            </div>


        </div>
    </div>

<!-- Alpine.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
<script>
function invoiceApp(){
    return {
        invoiceData: {
             contractorName: "",
             location: "",
             serviceNumber: "",
             reportDate: (new Date).toISOString().split("T")[0],
             officeName: "Area Office - "
         },
        currentItem: {
            ino: "",
            description: "",
            unit: "Nos",
            rate: 0,
            quantity: 0,
            amount: 0
        },
        lineItems: [],
        showSuggestions: false,
        showSaveNotification: false,
        serviceDescriptions: [
            {ino: "RA 1", description: "Pole transport (...........) Km", rate: 1500, unit: "Nos"},
            {ino: "RA 2", description: "Excavation of pole pits 6m/6.7m 15\" 30/33KV", rate: 2500, unit: "Nos"},
            {ino: "RA 3", description: "Excavation of pole pits 10-8.3m/100-11.5m (Existing...)", rate: 3000, unit: "Nos"},
            {ino: "RA 4", description: "Excavation of pole pits 590/250Kg", rate: 2200, unit: "Nos"},
            {ino: "RA 5", description: "Excavation of stay pit - LT", rate: 800, unit: "Nos"},
            {ino: "RA 6", description: "Erection of Pole/- 6m/8.5m W/R/Cpoles", rate: 4500, unit: "Nos"},
            {ino: "RA 7", description: "Erection of Pole - 9m/8.5m W/R/C poles", rate: 5000, unit: "Nos"},
            {ino: "RA 8", description: "Erection of Pole - 9m/250/300m RC poles", rate: 5500, unit: "Nos"},
            {ino: "RA 9", description: "Erection of feaut - LT W/RC", rate: 1200, unit: "Nos"},
            {ino: "RA 10", description: "Erection of stay LT - Normal", rate: 1800, unit: "Nos"},
            {ino: "RA 11", description: "Concreting of pole pits 9/250Kg and 9/500", rate: 3500, unit: "Nos"},
            {ino: "RA 12", description: "Removal of stay completely", rate: 800, unit: "Nos"},
            {ino: "RA 13", description: "Removal of Hardware from Existing LV Poles 1ph/3ph", rate: 600, unit: "Nos"},
            {ino: "RA 14", description: "Stringing of AAC/ABC Conductors 1ph/3ph", rate: 8500, unit: "Km"},
            {ino: "RA 15", description: "Removal of AAC/ABC Conductors 1ph/3ph", rate: 2500, unit: "Km"},
            {ino: "RA 16", description: "Re-Tensioning of AAC (Fly) Conductors", rate: 1500, unit: "Km"},
            {ino: "RA 17", description: "Re-Tensioning of ABC - 1ph/3ph", rate: 1800, unit: "Km"},
            {ino: "RA 18", description: "Removal of Pole/Struct - 8.3/9m - Wooden Re-usable", rate: 1200, unit: "Nos"},
            {ino: "RA 19", description: "Removal of Pole/Struct - 8.3/9m - RC Re-usable", rate: 1500, unit: "Nos"},
            {ino: "RA 20", description: "Removal of Pole/Struct - 6m/8.5m/9m - W/RC Un-usable", rate: 800, unit: "Nos"},
            {ino: "RA 21", description: "Removal and reconnection of service wire 1ph/3ph", rate: 450, unit: "Nos"},
            {ino: "RA 22", description: "Changing of service Wire with New wire (Length of service below 30m/Length of service above 30m)", rate: 650, unit: "Nos"},
            {ino: "RA 23", description: "Rehabilitation of existing services (Length of service below 30m/Length of service above 30m)", rate: 750, unit: "Nos"}
        ],

        // localStorage keys
        storageKeys: {
            invoiceData: 'ceb_invoice_data',
            lineItems: 'ceb_line_items',
            lastSaved: 'ceb_last_saved'
        },

        init() {
            this.loadFromStorage();
            // Auto-save every 30 seconds
            setInterval(() => {
                this.saveToStorage();
            }, 30000);
            
            // Keyboard shortcut for saving (Ctrl+S)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    this.saveInvoice();
                }
            });
        },

        // Save data to localStorage
        saveToStorage() {
            try {
                const dataToSave = {
                    invoiceData: this.invoiceData,
                    lineItems: this.lineItems,
                    timestamp: new Date().toISOString().split("T")[0]
                };
                
                localStorage.setItem(this.storageKeys.invoiceData, JSON.stringify(dataToSave));
                localStorage.setItem(this.storageKeys.lastSaved, new Date().toLocaleString());
                
                console.log('Invoice data saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        },

        // Show save notification
        displaySaveNotification() {
            this.showSaveNotification = true;
            setTimeout(() => {
                this.showSaveNotification = false;
            }, 2000);
        },

        // Load data from localStorage
        loadFromStorage() {
            try {
                const savedData = localStorage.getItem(this.storageKeys.invoiceData);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    if (parsedData.invoiceData) {
                        this.invoiceData = { ...this.invoiceData, ...parsedData.invoiceData };
                    }
                    
                    if (parsedData.lineItems && Array.isArray(parsedData.lineItems)) {
                        this.lineItems = parsedData.lineItems;
                    }
                    
                    console.log('Invoice data loaded from localStorage');
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        },

        // Clear all saved data
        clearStorage() {
            try {
                localStorage.removeItem(this.storageKeys.invoiceData);
                localStorage.removeItem(this.storageKeys.lastSaved);
                console.log('All saved invoice data cleared');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
            }
        },

        // Get last saved timestamp
        getLastSaved() {
            return localStorage.getItem(this.storageKeys.lastSaved) || 'Never';
        },

        get filteredSuggestions() {
            const suggestions = this.currentItem.description ? 
                this.serviceDescriptions.filter(item => 
                    item.description.toLowerCase().includes(this.currentItem.description.toLowerCase()) ||
                    item.ino.toLowerCase().includes(this.currentItem.description.toLowerCase())
                ) : [];
            console.log('Filtered suggestions:', suggestions, 'for input:', this.currentItem.description);
            return suggestions;
        },

        get grandTotal() {
            return this.lineItems.reduce((total, item) => total + parseFloat(item.amount || 0), 0);
        },

        get printableRows() {
            const rows = [];
            const maxRows = 25;
            
            this.lineItems.forEach((item, index) => {
                rows.push({
                    sn: index + 1,
                    ino: item.ino,
                    description: item.description,
                    unit: item.unit,
                    rate: parseFloat(item.rate).toFixed(2),
                    quantity: parseFloat(item.quantity).toFixed(2),
                    amount: parseFloat(item.amount).toFixed(2),
                    // certifiedQty: parseFloat(item.quantity).toFixed(2),
                    // certifiedAmount: parseFloat(item.amount).toFixed(2)
                });
            });
            
            // Fill remaining rows with empty data
            if (this.lineItems.length < maxRows) {
                for (let i = this.lineItems.length; i < maxRows; i++) {
                    rows.push({
                        // sn: i + 1,
                        sn: "",
                        description: "",
                        unit: "",
                        rate: "",
                        quantity: "",
                        amount: "",
                        certifiedQty: "",
                        certifiedAmount: ""
                    });
                }
            }
            
            return rows;
        },

        selectSuggestion(suggestion) {
            this.currentItem.ino = suggestion.ino;
            this.currentItem.description = suggestion.description;
            this.currentItem.rate = suggestion.rate;
            this.currentItem.unit = suggestion.unit;
            this.showSuggestions = false;
            this.calculateAmount();
        },

        calculateAmount() {
            this.currentItem.amount = (this.currentItem.rate || 0) * (this.currentItem.quantity || 0);
        },

        canAddItem() {
            return this.currentItem.description && this.currentItem.rate > 0 && this.currentItem.quantity > 0;
        },

        addLineItem() {
            if (this.canAddItem()) {
                this.lineItems.push({
                    ino: this.currentItem.ino,
                    description: this.currentItem.description,
                    unit: this.currentItem.unit,
                    rate: this.currentItem.rate,
                    quantity: this.currentItem.quantity,
                    amount: this.currentItem.amount
                });
                
                this.currentItem = {
                    ino: "",
                    description: "",
                    unit: "Nos",
                    rate: 0,
                    quantity: 0,
                    amount: 0
                };
                
                // Save after adding item
                this.saveToStorage();
            }
        },

        removeLineItem(index) {
            if (confirm("üõë Are you sure you want to Delete " + " " + this.lineItems[index].ino + "?")) {
                this.lineItems.splice(index, 1);
                // Save after removing item
                this.saveToStorage();
            } else {
                console.log("Cancelled");
            }
        },

        formatDate(date) {
            if (!date) return "";
            const d = new Date(date);
            return d.toLocaleDateString("en-GB");
        },

        printInvoice() {
            window.print();
        },

        // Save manually
        saveInvoice() {
            this.saveToStorage();
            this.displaySaveNotification();
        },

        // Load manually
        loadInvoice() {
            this.loadFromStorage();
            this.displaySaveNotification();
        },

        // Clear all data
        clearInvoice() {
            if (confirm('üõë Are you sure you want to delete this invoice data and start a new one?')) {
                                 this.invoiceData = {
                     contractorName: "",
                     location: "",
                     serviceNumber: "",
                     reportDate: (new Date).toISOString().split("T")[0],
                     officeName: "Area Office - Matara"
                 };
                this.lineItems = [];
                this.currentItem = {
                    description: "",
                    unit: "Nos",
                    rate: 0,
                    quantity: 0,
                    amount: 0
                };
                this.clearStorage();
                this.displaySaveNotification();
            }
        }
    }
}
</script>


</body></html>